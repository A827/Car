<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Motoria • Car details</title>
  <link rel="icon" href="favicon.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="detail.css" />
</head>
<body>
  <!-- Header -->
  <header class="site-header" id="siteHeader">
    <div class="container header-inner">
      <a class="brand" href="index.html" aria-label="Motoria home">
        <svg class="logo" viewBox="0 0 64 64" aria-hidden="true">
          <rect x="4" y="20" width="56" height="24" rx="6"></rect>
          <circle cx="20" cy="48" r="6"></circle>
          <circle cx="48" cy="48" r="6"></circle>
        </svg>
        <span class="brand-name">Motoria</span>
      </a>
      <nav class="nav" aria-label="Primary">
        <button class="nav-toggle" id="navToggle" aria-expanded="false" aria-controls="navMenu" aria-label="Open menu">
          <span></span><span></span><span></span>
        </button>
        <ul id="navMenu" class="nav-menu">
          <li><a href="results.html">Buy</a></li>
          <li><a href="#">Sell</a></li>
          <li><a href="#">Finance</a></li>
          <li><a href="dealers.html">Dealers</a></li>
          <li class="divider" aria-hidden="true"></li>
          <li id="authSlot"></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- Breadcrumb -->
  <nav class="container crumbs" aria-label="Breadcrumb">
    <a href="index.html">Home</a> /
    <a href="results.html">Results</a> /
    <span id="crumbTitle">Car</span>
  </nav>

  <!-- HERO -->
  <section class="container hero">
    <div class="gallery">
      <img id="heroImg" class="hero-img" alt="Car photo" />
      <div id="thumbs" class="thumbs" role="list"></div>
    </div>

    <div class="hero-meta">
      <h1 id="title" class="car-title">Car title</h1>
      <div id="specs" class="muted"></div>

      <div class="price-actions">
        <div class="price-big" id="price">£0</div>
        <div class="row" style="gap:8px">
          <button id="saveBtn"  class="btn btn-ghost" type="button">Save</button>
          <button id="shareBtn" class="btn btn-ghost" type="button">Share</button>
          <button id="printBtn" class="btn btn-primary" type="button">Print</button>
        </div>
      </div>

      <div class="seller card">
        <div class="seller-row">
          <div>
            <div class="muted small">Seller</div>
            <div id="dealerName" class="seller-name">Dealer</div>
            <div class="stars" id="dealerStars" aria-label="Dealer rating"></div>
          </div>
          <ul class="badges">
            <li id="locBadge"   class="badge">—</li>
            <li id="yearBadge"  class="badge">—</li>
          </ul>
        </div>

        <!-- Quick contact CTAs -->
        <div class="row" style="gap:8px;margin-top:8px">
          <a id="waCta" class="btn btn-primary" target="_blank" rel="noopener">WhatsApp</a>
          <a id="callCta" class="btn">Call</a>
        </div>
      </div>
    </div>
  </section>

  <!-- CONTENT -->
  <main class="container details-grid" id="content">
    <!-- Left -->
    <section class="stack">
      <div class="card">
        <h2>Key facts</h2>
        <dl class="kv">
          <div><dt>Make</dt>     <dd id="makeVal">—</dd></div>
          <div><dt>Model</dt>    <dd id="modelVal">—</dd></div>
          <div><dt>Year</dt>     <dd id="yearVal">—</dd></div>
          <div><dt>Mileage</dt>  <dd id="kmVal">—</dd></div>
          <div><dt>Fuel</dt>     <dd id="fuelVal">—</dd></div>
          <div><dt>Gearbox</dt>  <dd id="boxVal">—</dd></div>
          <div><dt>Colour</dt>   <dd id="colourVal">—</dd></div>
          <div><dt>Owners</dt>   <dd id="ownersVal">—</dd></div>
        </dl>
      </div>

      <div class="card">
        <h2>Features</h2>
        <ul id="featureList" class="bullets two"></ul>
      </div>

      <div class="card">
        <h2>Description</h2>
        <p id="descText" class="muted">Seller has not provided a description.</p>
      </div>

      <div class="card">
        <div class="section-head">
          <h2>Similar cars</h2>
          <div class="actions">
            <button class="carousel-btn" id="simPrev" type="button" aria-label="Previous">‹</button>
            <button class="carousel-btn" id="simNext" type="button" aria-label="Next">›</button>
          </div>
        </div>
        <div id="similar" class="carousel" tabindex="0" aria-label="Similar listings"></div>
      </div>
    </section>

    <!-- Right -->
    <aside class="stack">
      <div class="card">
        <h2>Finance estimate</h2>
        <form id="finForm" class="grid2">
          <label>Deposit (£)
            <input name="deposit" type="number" min="0" step="100" value="2000" />
          </label>
          <label>APR (%)
            <input name="apr" type="number" min="0" step="0.1" value="7.9" />
          </label>
          <label>Months
            <input name="months" type="number" min="12" step="1" value="48" />
          </label>
          <button class="btn btn-primary" type="submit">Calculate</button>
        </form>
        <div id="finOut" class="muted" style="margin-top:8px"></div>
      </div>

      <div id="contact" class="card">
        <h2>Contact seller</h2>
        <form id="contactForm" class="stack gap8">
          <div class="grid2">
            <label>Your name
              <input name="name" placeholder="Name" required />
            </label>
            <label>Email
              <input name="email" type="email" placeholder="you@example.com" required />
            </label>
          </div>
          <label>Message
            <textarea name="msg" rows="4" placeholder="I'm interested in this car…"></textarea>
          </label>
          <button class="btn btn-primary" type="submit">Send</button>
        </form>
      </div>
    </aside>
  </main>

  <footer class="site-footer">
    <div class="container footer-grid">
      <div>
        <div class="brand-footer">
          <svg class="logo" viewBox="0 0 64 64" aria-hidden="true">
            <rect x="4" y="20" width="56" height="24" rx="6"></rect>
            <circle cx="20" cy="48" r="6"></circle>
            <circle cx="48" cy="48" r="6"></circle>
          </svg>
          <span>Motoria</span>
        </div>
        <p class="muted">© <span id="year"></span> Motoria Ltd.</p>
      </div>
    </div>
  </footer>

  <!-- Core -->
  <script src="app.js"></script>
  <script src="data.js"></script>

  <!-- Page controller -->
  <script>
  // Header basics
  const header = document.getElementById('siteHeader');
  addEventListener('scroll',()=>header.classList.toggle('elevated', scrollY>6));
  const yearEl = document.getElementById('year'); if (yearEl) yearEl.textContent = new Date().getFullYear();
  const navToggle=document.getElementById('navToggle');
  const navMenu=document.getElementById('navMenu');
  navToggle?.addEventListener('click', ()=>{
    const exp = navToggle.getAttribute('aria-expanded')==='true';
    navToggle.setAttribute('aria-expanded', String(!exp));
    navMenu.classList.toggle('open');
  });

  // Helpers
  const qs=(s,el=document)=>el.querySelector(s);
  const GBP = window.MotoriaData?.GBP || (n=>`£${(+n||0).toLocaleString('en-GB')}`);
  const KM  = window.MotoriaData?.KM  || (n=>`${(+n||0).toLocaleString('en-GB')} km`);

  // Load car from URL
  const id = new URLSearchParams(location.search).get('id');
  let CAR = window.MotoriaData?.getCarById?.(id) || null;

  // If not found, show graceful empty state
  if (!CAR){
    document.title = 'Listing not found • Motoria';
    qs('#content').innerHTML = `
      <div class="card" style="padding:16px">
        <h2>Listing not found</h2>
        <p class="muted">This vehicle may have been sold or the link is incorrect.</p>
        <p><a class="btn btn-primary" href="results.html">Back to results</a></p>
      </div>`;
  } else {
    // Page title + breadcrumb
    document.title = `${CAR.title} • Motoria`;
    qs('#crumbTitle').textContent = CAR.title || 'Car';
    qs('#title').textContent = CAR.title || 'Car';

    // Price/spec strip
    qs('#price').textContent = GBP(+CAR.price||0);
    qs('#specs').textContent = [CAR.year ? CAR.year : null, CAR.km!=null ? KM(+CAR.km||0) : null, CAR.fuel, CAR.gearbox, CAR.loc].filter(Boolean).join(' • ');

    // Seller/meta
    qs('#dealerName').textContent = CAR.dealer || 'Seller';
    const r = Math.round(CAR.rating||0); qs('#dealerStars').textContent = '★'.repeat(r) + '☆'.repeat(5 - r);
    qs('#locBadge').textContent = CAR.loc || '—';
    qs('#yearBadge').textContent = CAR.year || '—';

    // KV values
    const makeGuess = (CAR.make || (CAR.title||'').split(' ')[0] || '');
    const modelGuess= (CAR.model|| (CAR.title||'').split(' ').slice(1,3).join(' ') || '');
    qs('#makeVal').textContent   = makeGuess || '—';
    qs('#modelVal').textContent  = modelGuess || '—';
    qs('#yearVal').textContent   = CAR.year || '—';
    qs('#kmVal').textContent     = CAR.km!=null ? KM(+CAR.km||0) : '—';
    qs('#fuelVal').textContent   = CAR.fuel || '—';
    qs('#boxVal').textContent    = CAR.gearbox || '—';
    qs('#colourVal').textContent = CAR.colour || '—';
    qs('#ownersVal').textContent = CAR.owners!=null ? CAR.owners : '—';
    qs('#descText').textContent  = CAR.desc || qs('#descText').textContent;

    // Gallery
    const heroImg = qs('#heroImg');
    const thumbs = qs('#thumbs');
    const imgs = (CAR.images && CAR.images.length ? CAR.images : [CAR.img]).filter(Boolean);
    const Fallback = 'assets/cars/sportage.jpg';
    heroImg.loading = 'lazy'; heroImg.width = 1200; heroImg.height = 675;
    heroImg.src = imgs[0] || Fallback;
    heroImg.onerror = ()=>{ heroImg.removeAttribute('src'); heroImg.style.background='#eff3ff'; heroImg.alt='Photo unavailable'; };
    thumbs.innerHTML = imgs.map((src,i)=>`
      <button class="thumb ${i===0?'active':''}" type="button" aria-label="Photo ${i+1}">
        <img loading="lazy" width="200" height="140" src="${src}" alt="Thumbnail ${i+1}" />
      </button>`).join('');
    thumbs.addEventListener('click', e=>{
      const b = e.target.closest('.thumb'); if(!b) return;
      thumbs.querySelectorAll('.thumb').forEach(x=>x.classList.remove('active'));
      b.classList.add('active'); heroImg.src = b.querySelector('img').src;
    });
    // Keyboard gallery
    addEventListener('keydown', (e)=>{
      const items = Array.from(thumbs.querySelectorAll('.thumb'));
      if(!items.length) return;
      const idx = items.findIndex(x=>x.classList.contains('active'));
      if(e.key === 'ArrowRight'){ items[(idx+1)%items.length].click(); }
      if(e.key === 'ArrowLeft'){  items[(idx-1+items.length)%items.length].click(); }
    });

    // Finance estimator
    qs('#finForm').addEventListener('submit', e=>{
      e.preventDefault();
      const fd = new FormData(e.currentTarget);
      const deposit = +fd.get('deposit')||0;
      const apr = (+fd.get('apr')||0)/100/12;
      const months = +fd.get('months')||48;
      const principal = Math.max(0, (+CAR.price||0) - deposit);
      const m = apr>0 ? (principal * (apr * Math.pow(1+apr, months))) / (Math.pow(1+apr, months) - 1) : (months? principal / months : 0);
      qs('#finOut').textContent = `Approx. £${Math.round(m).toLocaleString('en-GB')} / month for ${months} months.`;
    });

    // Actions
    qs('#contactForm').addEventListener('submit', e=>{ e.preventDefault(); alert('Message sent to seller. (Demo)'); });
    qs('#saveBtn').addEventListener('click', ()=>{ window.MotoriaData?.saveCar?.(CAR); alert('Saved!'); });
    qs('#shareBtn').addEventListener('click', ()=>{ navigator.clipboard?.writeText(location.href); alert('Link copied'); });
    qs('#printBtn').addEventListener('click', ()=>print());

    // Quick contact links (replace numbers!)
    const phone = CAR.phone || '+90533XXXXXXX';
    const waMsg = encodeURIComponent(`Interested in ${CAR.title}`);
    qs('#waCta').href   = `https://wa.me/${phone.replace(/\D/g,'')}?text=${waMsg}`;
    qs('#callCta').href = `tel:${phone}`;

    // Features
    const featEl = qs('#featureList');
    featEl.innerHTML = (CAR.features||[]).map(f=>`<li>${f}</li>`).join('');

    // Similar cars (use helper)
    (function renderSimilar(){
      const pick = (window.MotoriaData?.getSimilarCars?.(CAR, 8)) || [];
      const el = qs('#similar');
      const GBPf = n => new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP',maximumFractionDigits:0}).format(+n||0);
      el.innerHTML = pick.map(s=>`
        <article class="card">
          <a href="detail.html?id=${s.id}">
            <img class="card-img" loading="lazy" width="400" height="300"
                 src="${s.img||''}" alt="${s.title||'Car'}"
                 onerror="this.style.background='#eff3ff'; this.removeAttribute('src')">
          </a>
          <div class="card-body">
            <div class="price">${GBPf(s.price)}</div>
            <div class="meta">${s.title||''}</div>
          </div>
        </article>
      `).join('');
      qs('#simPrev').onclick=()=>el.scrollBy({left:-360,behavior:'smooth'});
      qs('#simNext').onclick=()=>el.scrollBy({left: 360,behavior:'smooth'});
    })();

    // ---- Vehicle JSON-LD (SEO) ----
    (function injectVehicleJsonLd(){
      try {
        const v = {
          "@context":"https://schema.org",
          "@type":"Vehicle",
          "name": CAR.title,
          "brand": CAR.make || (CAR.title||'').split(' ')[0] || "",
          "model": CAR.model || (CAR.title||'').split(' ').slice(1,3).join(' ') || "",
          "vehicleModelDate": String(CAR.year||''),
          "mileageFromOdometer": { "@type":"QuantitativeValue", "value": +CAR.km||0, "unitCode": "KMT" },
          "color": CAR.colour || "",
          "image": (CAR.images && CAR.images[0]) ? new URL(CAR.images[0], location.href).toString() : (CAR.img ? new URL(CAR.img, location.href).toString() : ""),
          "offers": {
            "@type":"Offer",
            "price": String(CAR.price||''),
            "priceCurrency":"GBP",
            "availability":"https://schema.org/InStock",
            "url": location.href
          },
          "seller": {
            "@type":"Organization",
            "name": CAR.dealer || "Seller",
            "url": location.origin + "/dealers.html"
          }
        };
        const s = document.createElement('script');
        s.type = 'application/ld+json';
        s.textContent = JSON.stringify(v);
        document.head.appendChild(s);
      } catch(e){}
    })();
  }
  </script>
</body>
</html>